generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id           String              @id @default(uuid())
  domain       String              @unique
  name         String
  settings     Json
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  branches     Branch[]
  featureFlags PortalFeatureFlags?

  @@map("tenants")
}

model Branch {
  id                          String    @id @default(uuid())
  tenantId                    String
  name                        String
  slug                        String
  title                       String?
  description                 String?
  themeId                     String?
  defaultLanguage             String    @default("en")
  aiEnabled                   Boolean   @default(true)
  settings                    Json      @default("{}")
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  aiFeaturesEnabled           Boolean   @default(false)
  allowedDomains              String[]
  badgeSet                    String    @default("old-school")
  brandingFaviconUrl          String?
  brandingLogoUrl             String?
  creditsEnabled              Boolean   @default(false)
  defaultCourseImageUrl       String?
  defaultGroupId              String?
  defaultUserTypeId           String?
  disallowMainDomainLogin     Boolean   @default(false)
  ecommerceProcessor          String?
  externalAnnouncement        String?
  externalAnnouncementEnabled Boolean   @default(false)
  internalAnnouncement        String?
  internalAnnouncementEnabled Boolean   @default(false)
  isActive                    Boolean   @default(false)
  languageCode                String    @default("en")
  maxRegistrations            Int?
  signupMode                  String    @default("direct")
  subscriptionEnabled         Boolean   @default(false)
  termsOfService              String?
  timezone                    String    @default("UTC")
  defaultGroup                Group?    @relation("BranchDefaultGroup", fields: [defaultGroupId], references: [id])
  defaultUserType             UserType? @relation("BranchDefaultUserType", fields: [defaultUserTypeId], references: [id])
  tenant                      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users                       User[]

  @@unique([tenantId, slug])
  @@map("branches")
}

model User {
  id                      String                 @id @default(uuid())
  username                String                 @unique
  email                   String                 @unique
  firstName               String
  lastName                String
  bio                     String?
  timezone                String                 @default("UTC")
  language                String                 @default("en")
  userTypeId              String?
  passwordHash            String?                @map("passwordHash")
  avatar                  String?
  status                  UserStatus             @default(ACTIVE)
  deactivateAt            DateTime?
  role                    RoleKey                @default(LEARNER) @map("activeRole")
  isActive                Boolean                @default(true) @map("is_active")
  isVerified              Boolean                @default(false) @map("is_verified")
  lastLoginAt             DateTime?              @map("lastLoginAt")
  failedLoginAttempts     Int                    @default(0)
  lockedUntil             DateTime?
  excludeFromEmails       Boolean                @default(false)
  certificatesArchive     Json?
  rbacOverrides           Json?                  @map("rbac_overrides")
  nodeId                  String?                @map("node_id")
  node                    Branch?                @relation(fields: [nodeId], references: [id])
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  instructorEvents        CalendarEvent[]        @relation("InstructorEvents")
  instructorConferences   Conference[]           @relation("InstructorConferences")
  instructorGroups        Group[]                @relation("InstructorGroups")
  learner_course_state    learner_course_state[]
  instructorLearningPaths LearningPath[]         @relation("InstructorLearningPaths")
  sentRecommendations     SkillRecommendation[]  @relation("SentRecommendations")
  receivedRecommendations SkillRecommendation[]  @relation("ReceivedRecommendations")
  roles                   UserRole[]
  userSkills              UserSkill[]
  userType                UserType?              @relation(fields: [userTypeId], references: [id])

  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleKey   RoleKey
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleKey])
  @@map("user_roles")
}

// ============= RBAC Tables (Auth System) =============

model AuthRole {
  id               String                @id @default(uuid())
  name             String                @unique
  description      String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  rolePermissions  AuthRolePermission[]

  @@map("auth_role")
}

model AuthPermission {
  id               String                @id @default(uuid())
  name             String                @unique
  fullPermission   String                @unique
  description      String?
  createdAt        DateTime              @default(now())
  rolePermissions  AuthRolePermission[]

  @@map("auth_permission")
}

model AuthRolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime       @default(now())
  role         AuthRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   AuthPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("auth_role_permission")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@map("password_reset_tokens")
}

model UserType {
  id          String   @id @default(uuid())
  name        String   @unique
  permissions Json
  createdAt   DateTime @default(now())
  branches    Branch[] @relation("BranchDefaultUserType")
  users       User[]

  @@map("user_types")
}

model Course {
  id                       String                 @id @default(uuid())
  code                     String                 @unique
  title                    String
  description              String?
  status                   CourseStatus           @default(DRAFT)
  hiddenFromCatalog        Boolean                @default(false)
  introVideoType           String?
  introVideoUrl            String?
  capacity                 Int?
  timeLimit                Int?
  expiration               DateTime?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  accessRetentionEnabled   Boolean                @default(false)
  categoryId               String?
  certificateTemplateId    String?
  coachEnabled             Boolean                @default(false)
  completionRule           String                 @default("all")
  contentLocked            Boolean                @default(false)
  enrollmentRequestEnabled Boolean                @default(false)
  isActive                 Boolean                @default(false)
  price                    Decimal?               @db.Decimal(10, 2)
  publicSharingEnabled     Boolean                @default(false)
  requiredLevel            Int?
  scoreCalculation         String                 @default("all")
  showInCatalog            Boolean                @default(true)
  timeLimitType            String?
  unitsOrdering            String                 @default("sequential")
  instructorId             String?
  lastPublishedAt          DateTime?
  publishedVersionId       String?
  version                  Int                    @default(1)
  settings                 Json                   @default("{}")
  thumbnail_url            String?
  subtitle                 String?
  enrollmentKey            String?                @unique
  assignments              Assignment[]
  files                    CourseFile[]
  instructors              CourseInstructor[]
  sections                 CourseSection[]
  skills                   CourseSkill[]
  versions                 CourseVersion[]
  enrollmentRequests       EnrollmentRequest[]
  enrollments              Enrollment[]
  learner_course_state     learner_course_state[]
  learningPaths            LearningPathCourse[]
  assets                   UnitAsset[]

  @@map("courses")
}

model CourseSection {
  id          String       @id @default(uuid())
  courseId    String
  title       String
  dripEnabled Boolean      @default(false)
  dripType    String?
  dripValue   Int?
  order_index Int
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  units       CourseUnit[]

  @@map("course_sections")
}

model CourseVersion {
  id            String   @id @default(uuid())
  courseId      String
  versionNumber Int
  snapshot      Json
  createdAt     DateTime @default(now())
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("course_versions")
}

model CourseFile {
  id        String   @id @default(uuid())
  courseId  String
  name      String
  url       String
  sizeBytes BigInt
  mimeType  String
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("course_files")
}

model EnrollmentRequest {
  id         String    @id @default(uuid())
  courseId   String
  userId     String
  status     String    @default("pending")
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
  resolvedBy String?
  course     Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("enrollment_requests")
}

model CourseInstructor {
  courseId String
  userId   String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([courseId, userId])
  @@map("course_instructors")
}

model Enrollment {
  id             String           @id @default(uuid())
  userId         String
  courseId       String
  status         EnrollmentStatus @default(NOT_STARTED)
  progress       Int              @default(0)
  score          Decimal?         @db.Decimal(5, 2)
  startedAt      DateTime?
  completedAt    DateTime?
  expiresAt      DateTime?
  certificateId  String?
  lastAccessedAt DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

model CourseUnit {
  id                   String                 @id @default(uuid())
  courseId             String
  type                 UnitType
  title                String
  status               UnitStatus             @default(DRAFT)
  isSample             Boolean                @default(false)
  versionHistory       Json?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  linkSourceUnitId     String?
  sectionId            String?
  config               Json
  order_index          Int
  section              CourseSection?         @relation(fields: [sectionId], references: [id])
  learner_course_state learner_course_state[]
  assets               UnitAsset[]

  @@map("course_units")
}

model UnitAsset {
  id         String     @id @default(uuid())
  courseId   String
  unitId     String
  kind       String
  url        String
  storageKey String?
  name       String
  sizeBytes  BigInt
  mimeType   String
  createdAt  DateTime   @default(now())
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  unit       CourseUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@map("unit_assets")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  parentId    String?
  description String?
  price       Decimal? @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  @@map("categories")
}

model Group {
  id           String        @id @default(uuid())
  name         String
  description  String?       @db.VarChar(500)
  maxMembers   Int?
  branchId     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  autoEnroll   Boolean       @default(false)
  groupKey     String?       @unique
  price        Decimal?      @db.Decimal(10, 2)
  instructorId String?
  branches     Branch[]      @relation("BranchDefaultGroup")
  courses      GroupCourse[]
  members      GroupMember[]
  instructor   User?         @relation("InstructorGroups", fields: [instructorId], references: [id])

  @@map("groups")
}

model GroupMember {
  id      String   @id @default(uuid())
  groupId String
  userId  String
  addedAt DateTime @default(now())
  group   Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model GroupCourse {
  id       String   @id @default(uuid())
  groupId  String
  courseId String
  addedAt  DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, courseId])
  @@map("group_courses")
}

model LearningPath {
  id                     String                @id @default(uuid())
  name                   String
  code                   String?               @unique
  description            String?
  image                  String?
  isActive               Boolean               @default(false)
  limitDays              Int?
  accessRetention        Int?
  isSequential           Boolean               @default(false)
  certificateId          String?
  maxCourses             Int                   @default(25)
  branchId               String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  category               String?
  status                 String                @default("inactive")
  accessRetentionEnabled Boolean               @default(false)
  certificateType        CertificateType?
  completionDaysLimit    Int?
  courseOrderMode        CourseOrderMode       @default(ANY)
  completionRule         CompletionRule        @default(ALL_COURSES_COMPLETED)
  instructorId           String?
  courses                LearningPathCourse[]
  sections               LearningPathSection[]
  skills                 LearningPathSkill[]
  instructor             User?                 @relation("InstructorLearningPaths", fields: [instructorId], references: [id])

  @@map("learning_paths")
}

model LearningPathSection {
  id        String               @id @default(uuid())
  pathId    String
  name      String
  order     Int
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  courses   LearningPathCourse[]
  path      LearningPath         @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@map("learning_path_sections")
}

model LearningPathCourse {
  id             String               @id @default(uuid())
  pathId         String
  courseId       String
  order          Int
  createdAt      DateTime             @default(now())
  minScore       Int?
  unlockCourseId String?
  unlockType     UnlockType           @default(NONE)
  sectionId      String?
  course         Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  learningPath   LearningPath         @relation(fields: [pathId], references: [id], onDelete: Cascade)
  section        LearningPathSection? @relation(fields: [sectionId], references: [id])

  @@unique([pathId, courseId])
  @@map("learning_path_courses")
}

model LearningPathEnrollment {
  id          String    @id @default(uuid())
  userId      String
  pathId      String
  role        RoleKey   @default(LEARNER)
  status      String    @default("NOT_STARTED")
  progress    Int       @default(0)
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, pathId])
  @@map("learning_path_enrollments")
}

model Prerequisite {
  id               String @id @default(uuid())
  courseId         String
  pathIndex        Int
  requiredCourseId String
  requiredLevel    Int?

  @@unique([courseId, pathIndex, requiredCourseId])
  @@map("prerequisites")
}

model Skill {
  id                   String                @id @default(uuid())
  name                 String
  description          String?
  aiInstructions       String?
  numQuestionsRequired Int                   @default(10)
  timerDuration        Int?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  imageUrl             String?
  courseSkills         CourseSkill[]
  learningPathSkills   LearningPathSkill[]
  roleSkills           RoleSkill[]
  questions            SkillQuestion[]
  recommendations      SkillRecommendation[]
  resources            SkillResource[]
  userSkills           UserSkill[]

  @@map("skills")
}

model UserSkill {
  userId    String
  skillId   String
  level     SkillLevel @default(BEGINNER)
  progress  Int        @default(0)
  evidence  Json?
  updatedAt DateTime   @updatedAt
  skill     Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, skillId])
  @@map("user_skills")
}

model SkillQuestion {
  id            String  @id @default(uuid())
  skillId       String
  question      String
  options       Json
  correctAnswer String
  aiGenerated   Boolean @default(false)
  order         Int
  skill         Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@map("skill_questions")
}

model CourseSkill {
  courseId String
  skillId  String
  weight   Int    @default(1)
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  skill    Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([courseId, skillId])
  @@map("course_skills")
}

model LearningPathSkill {
  learningPathId String
  skillId        String
  weight         Int          @default(1)
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  skill          Skill        @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([learningPathId, skillId])
  @@map("learning_path_skills")
}

model JobRole {
  id          String      @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  skills      RoleSkill[]

  @@map("job_roles")
}

model RoleSkill {
  roleId        String
  skillId       String
  requiredLevel SkillLevel @default(BEGINNER)
  weight        Int        @default(1)
  role          JobRole    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  skill         Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([roleId, skillId])
  @@map("role_skills")
}

model SkillRecommendation {
  id         String   @id @default(uuid())
  fromUserId String
  toUserId   String
  skillId    String
  note       String?
  createdAt  DateTime @default(now())
  fromUser   User     @relation("SentRecommendations", fields: [fromUserId], references: [id], onDelete: Cascade)
  skill      Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  toUser     User     @relation("ReceivedRecommendations", fields: [toUserId], references: [id], onDelete: Cascade)

  @@map("skill_recommendations")
}

model SkillResource {
  id      String @id @default(uuid())
  skillId String
  title   String
  url     String
  order   Int
  skill   Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@map("skill_resources")
}

model CalendarEvent {
  id           String   @id @default(uuid())
  title        String
  description  String?
  startTime    DateTime
  endTime      DateTime
  createdAt    DateTime @default(now())
  instructorId String
  type         String
  updatedAt    DateTime @updatedAt
  instructor   User     @relation("InstructorEvents", fields: [instructorId], references: [id])

  @@map("calendar_events")
}

model Conference {
  id           String   @id @default(uuid())
  startTime    DateTime
  duration     Int
  createdAt    DateTime @default(now())
  description  String?
  endTime      DateTime
  instructorId String
  meetingUrl   String?
  title        String
  updatedAt    DateTime @updatedAt
  instructor   User     @relation("InstructorConferences", fields: [instructorId], references: [id])

  @@map("conferences")
}

model ConferenceParticipant {
  id           String  @id @default(uuid())
  conferenceId String
  userId       String
  notified     Boolean @default(false)

  @@unique([conferenceId, userId])
  @@map("conference_participants")
}

model LRSStatement {
  id        String   @id @default(uuid())
  actor     Json
  verb      Json
  object    Json
  result    Json?
  context   Json?
  timestamp DateTime @default(now())
  stored    DateTime @default(now())
  authority Json?
  version   String   @default("1.0.3")

  @@map("lrs_statements")
}

model SCORMData {
  id             String   @id @default(uuid())
  userId         String
  unitId         String
  lessonStatus   String?
  lessonLocation String?
  suspendData    String?
  scoreRaw       Float?
  scoreMax       Float?
  scoreMin       Float?
  sessionTime    String?
  totalTime      String?
  updatedAt      DateTime @updatedAt

  @@unique([userId, unitId])
  @@map("scorm_data")
}

model GamificationSettings {
  id                 String  @id @default(uuid())
  portalId           String?
  branchId           String?
  enabled            Boolean @default(true)
  pointsEnabled      Boolean @default(true)
  badgesEnabled      Boolean @default(true)
  levelsEnabled      Boolean @default(true)
  rewardsEnabled     Boolean @default(true)
  leaderboardEnabled Boolean @default(true)
  pointsPerLogin     Int     @default(10)
  maxLevel           Int     @default(20)

  @@map("gamification_settings")
}

model PointsLedger {
  id        String   @id @default(uuid())
  userId    String
  points    Int
  reason    String
  createdAt DateTime @default(now())

  @@map("points_ledger")
}

model Badge {
  id          String   @id @default(uuid())
  name        String
  description String?
  image       String
  criteria    Json
  createdAt   DateTime @default(now())

  @@map("badges")
}

model Level {
  id             String  @id @default(uuid())
  levelNumber    Int     @unique
  pointsRequired Int
  name           String
  badge          String?

  @@map("levels")
}

model Reward {
  id              String  @id @default(uuid())
  name            String
  type            String
  discountPercent Int?
  criteria        Json
  active          Boolean @default(true)

  @@map("rewards")
}

model Notification {
  id              String                @id @default(uuid())
  name            String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  eventKey        String
  filterBranches  String[]              @default([])
  filterCourses   String[]              @default([])
  filterGroups    String[]              @default([])
  hoursOffset     Int?
  isActive        Boolean               @default(true)
  messageBody     String
  messageSubject  String
  offsetDirection String?
  recipientType   String
  recipientUserId String?
  history         NotificationHistory[]
  queue           NotificationQueue[]

  @@map("notifications")
}

model NotificationHistory {
  id              String       @id @default(uuid())
  notificationId  String
  recipientEmail  String
  recipientUserId String?
  eventKey        String
  contextJson     Json?
  sentAt          DateTime     @default(now())
  status          String
  errorMessage    String?
  notification    Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@map("notification_history")
}

model NotificationQueue {
  id              String       @id @default(uuid())
  notificationId  String
  scheduledFor    DateTime
  recipientUserId String
  recipientEmail  String
  payloadJson     Json
  status          String       @default("PENDING")
  processedAt     DateTime?
  errorMessage    String?
  createdAt       DateTime     @default(now())
  notification    Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@map("notification_queue")
}

model Automation {
  id         String   @id @default(uuid())
  name       String
  type       String
  parameters Json
  filters    Json?
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("automations")
}

model AutomationLog {
  id           String   @id @default(uuid())
  automationId String
  userId       String
  status       String
  details      Json?
  executedAt   DateTime @default(now())

  @@map("automation_logs")
}

model CertificateTemplate {
  id        String   @id @default(uuid())
  name      String
  htmlBody  String
  smartTags Json
  isSystem  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("certificate_templates")
}

model CertificateIssue {
  id             String    @id @default(uuid())
  userId         String
  courseId       String?
  pathId         String?
  templateId     String
  issuedAt       DateTime  @default(now())
  lastIssuedDate DateTime  @default(now())
  expiresAt      DateTime?
  linkedInShared Boolean   @default(false)

  @@map("certificate_issues")
}

model Homepage {
  id        String   @id @default(uuid())
  portalId  String?
  branchId  String?
  type      String
  isActive  Boolean  @default(false)
  menuItems Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("homepages")
}

model HomepageSection {
  id         String  @id @default(uuid())
  homepageId String
  type       String
  content    Json
  order      Int
  hasDivider Boolean @default(false)

  @@map("homepage_sections")
}

model TalentLibraryCourse {
  id             String  @id @default(uuid())
  externalId     String  @unique
  title          String
  description    String?
  previewTrailer String?
  categories     Json
  isPromoted     Boolean @default(false)
  license        Json

  @@map("talent_library_courses")
}

model AcquiredLibraryCourse {
  id                String   @id @default(uuid())
  libraryCourseId   String
  localCourseId     String
  hiddenFromCatalog Boolean  @default(true)
  acquiredAt        DateTime @default(now())

  @@map("acquired_library_courses")
}

model Report {
  id        String   @id @default(uuid())
  name      String
  type      String
  ruleset   Json
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reports")
}

model ScheduledReport {
  id         String    @id @default(uuid())
  reportId   String
  frequency  String
  config     Json
  recipients Json
  nextRunAt  DateTime
  lastRunAt  DateTime?
  active     Boolean   @default(true)

  @@map("scheduled_reports")
}

model AnalyticsDashboard {
  id          String   @id @default(uuid())
  title       String
  targetType  String
  targetId    String?
  bannerImage String?
  widgets     Json
  filters     Json
  isDefault   Boolean  @default(false)
  createdBy   String
  createdAt   DateTime @default(now())

  @@map("analytics_dashboards")
}

model ReportExport {
  id          String    @id @default(uuid())
  reportType  String
  format      String
  fileName    String
  filePath    String?
  fileSize    Int?
  status      String
  filters     Json?
  generatedBy String
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@map("report_exports")
}

model TimelineEvent {
  id        String   @id @default(uuid())
  userId    String?
  courseId  String?
  eventType String
  details   Json
  timestamp DateTime @default(now())

  @@map("timeline_events")
}

model Discussion {
  id           String       @id @default(uuid())
  topic        String
  body         String
  audienceType AudienceType
  audienceId   String?
  branchId     String?
  createdBy    String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("discussions")
}

model DiscussionComment {
  id           String   @id @default(uuid())
  discussionId String
  body         String
  createdBy    String
  createdAt    DateTime @default(now())

  @@map("discussion_comments")
}

model Attachment {
  id         String   @id @default(uuid())
  entityType String
  entityId   String
  filename   String
  filepath   String
  filesize   Int
  uploadedBy String
  uploadedAt DateTime @default(now())

  @@map("attachments")
}

model DiscussionModerationSettings {
  id              String @id @default(uuid())
  editWindowHours Int    @default(2)
  moderatorRole   String @default("Instructor")
  settings        Json

  @@map("discussion_moderation_settings")
}

model Integration {
  id        String   @id @default(uuid())
  type      String
  enabled   Boolean  @default(false)
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("integrations")
}

model APIKey {
  id          String   @id @default(uuid())
  keyHash     String   @unique
  description String?
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("api_keys")
}

model SSOConfig {
  id        String   @id @default(uuid())
  provider  String
  config    Json
  enabled   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sso_configs")
}

model ImpersonationSession {
  id           String    @id @default(uuid())
  adminId      String
  targetUserId String
  reason       String?
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  active       Boolean   @default(true)

  @@map("impersonation_sessions")
}

model ImportJob {
  id          String    @id @default(uuid())
  type        String
  filename    String
  status      String
  totalRows   Int
  successRows Int       @default(0)
  errorRows   Int       @default(0)
  errors      Json?
  uploadedBy  String
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@map("import_jobs")
}

model ImportResult {
  id          String  @id @default(uuid())
  importJobId String
  rowNumber   Int
  status      String
  message     String?
  data        Json?

  @@map("import_results")
}

model UploadPolicy {
  id           String @id @default(uuid())
  planTier     String
  fileType     String
  maxSizeMB    Int
  restrictions Json?

  @@map("upload_policies")
}

model MessageThread {
  id        String   @id @default(uuid())
  subject   String
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("message_threads")
}

model Message {
  id          String   @id @default(uuid())
  threadId    String
  senderId    String
  body        String
  attachments Json?
  sentAt      DateTime @default(now())

  @@map("messages")
}

model MessageRecipient {
  id       String    @id @default(uuid())
  threadId String
  userId   String
  isRead   Boolean   @default(false)
  readAt   DateTime?

  @@unique([threadId, userId])
  @@map("message_recipients")
}

model MessagingPermissions {
  id                    String  @id @default(uuid())
  userTypeId            String
  canMessageAdmins      Boolean @default(true)
  canMessageUsers       Boolean @default(true)
  canMessageInstructors Boolean @default(true)

  @@map("messaging_permissions")
}

model File {
  id          String   @id @default(uuid())
  filename    String
  filepath    String?
  externalUrl String?
  filesize    Int?
  mimeType    String
  ownerType   String
  ownerId     String
  uploadedBy  String
  isShared    Boolean  @default(false)
  canShare    Boolean  @default(true)
  uploadedAt  DateTime @default(now())

  @@map("files")
}

model FileVisibility {
  id      String  @id @default(uuid())
  fileId  String
  userId  String
  canView Boolean @default(true)

  @@unique([fileId, userId])
  @@map("file_visibility")
}

model AssignmentSubmission {
  id               String    @id @default(uuid())
  assignmentUnitId String
  userId           String
  courseId         String
  submissionType   String
  content          String?
  fileId           String?
  submittedAt      DateTime  @default(now())
  gradedAt         DateTime?
  gradedBy         String?
  score            Int?
  maxScore         Int       @default(100)
  status           String
  comment          String?

  @@map("assignment_submissions")
}

model ILTSession {
  id           String   @id @default(uuid())
  iltUnitId    String
  courseId     String
  sessionDate  DateTime
  duration     Int
  provider     String
  providerData Json

  @@map("ilt_sessions")
}

model ILTAttendance {
  id        String    @id @default(uuid())
  sessionId String
  userId    String
  attended  Boolean   @default(false)
  score     Int?
  status    String
  gradedAt  DateTime?
  gradedBy  String?
  comment   String?

  @@unique([sessionId, userId])
  @@map("ilt_attendance")
}

model Test {
  id              String   @id @default(uuid())
  unitId          String
  isRandomized    Boolean  @default(false)
  questionsToShow Int?
  passingScore    Int      @default(50)
  settings        Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("tests")
}

model Question {
  id             String   @id @default(uuid())
  testId         String?
  questionPoolId String?
  type           String
  text           String
  options        Json?
  correctAnswer  Json
  points         Int      @default(1)
  feedback       String?
  tags           Json?
  aiGenerated    Boolean  @default(false)
  order          Int      @default(0)
  createdAt      DateTime @default(now())

  @@map("questions")
}

model QuestionPool {
  id           String   @id @default(uuid())
  name         String
  courseId     String?
  minQuestions Int      @default(2)
  createdAt    DateTime @default(now())

  @@map("question_pools")
}

model FreeTextKeyword {
  id             String  @id @default(uuid())
  questionId     String
  keyword        String
  pointsModifier Int
  isRequired     Boolean @default(false)

  @@map("free_text_keywords")
}

model TestAttempt {
  id          String    @id @default(uuid())
  testId      String
  userId      String
  courseId    String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  score       Int?
  maxScore    Int
  passed      Boolean   @default(false)
  answers     Json

  @@map("test_attempts")
}

model CourseRatingSetting {
  id       String  @id @default(uuid())
  tenantId String
  enabled  Boolean @default(false)

  @@map("course_rating_settings")
}

model CourseRating {
  id        String   @id @default(uuid())
  courseId  String
  userId    String
  rating    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, userId])
  @@map("course_ratings")
}

model EnrollmentExtension {
  id                String   @id @default(uuid())
  enrollmentId      String
  userId            String
  courseId          String
  newExpirationDate DateTime
  extendedBy        String
  reason            String?
  extendedAt        DateTime @default(now())

  @@map("enrollment_extensions")
}

model PortalFeatureFlags {
  id                   String   @id @default(uuid())
  tenantId             String   @unique
  createdAt            DateTime @default(now())
  planTier             String
  prerequisitesEnabled Boolean  @default(true)
  learningPathsEnabled Boolean  @default(false)
  learningPathsLimit   Int?
  messagingEnabled     Boolean  @default(false)
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("portal_feature_flags")
}

model Assignment {
  id          String    @id @default(uuid())
  title       String
  description String?
  courseId    String?
  dueAt       DateTime?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  course      Course?   @relation(fields: [courseId], references: [id])

  @@map("assignments")
}

model learner_course_state {
  id             String      @id @default(uuid())
  userId         String
  courseId       String
  lastUnitId     String?
  lastAccessedAt DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  course         Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  unit           CourseUnit? @relation(fields: [lastUnitId], references: [id])
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

enum UserStatus {
  ACTIVE
  INACTIVE
  DEACTIVATED
  LOCKED
}

enum RoleKey {
  ADMIN
  INSTRUCTOR
  LEARNER
  SUPER_INSTRUCTOR
}

enum CourseStatus {
  DRAFT
  PUBLISHED
}

enum EnrollmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
  EXPIRED
}

enum UnitType {
  TEXT
  FILE
  EMBED
  VIDEO
  TEST
  SURVEY
  ASSIGNMENT
  ILT
  CMI5
  TALENTCRAFT
  SECTION
  WEB
  AUDIO
  DOCUMENT
  IFRAME
  SCORM
  XAPI
}

enum UnitStatus {
  DRAFT
  PUBLISHED
  UNPUBLISHED_CHANGES
}

enum UnlockType {
  NONE
  AFTER_COURSE
  AFTER_SCORE
}

enum CourseOrderMode {
  SEQUENTIAL
  ANY
}

enum CompletionRule {
  ALL_COURSES_COMPLETED
}

enum CertificateType {
  CLASSIC
  FANCY
  MODERN
  SIMPLE
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum AudienceType {
  EVERYONE
  BRANCH
  GROUP
  COURSE
  SPECIFIC_USERS
}
